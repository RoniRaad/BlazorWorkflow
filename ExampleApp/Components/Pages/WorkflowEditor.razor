@page "/workflow/{WorkflowId}"
@using BlazorExecutionFlow.Components
@using BlazorExecutionFlow.Flow.BaseNodes
@using BlazorExecutionFlow.Helpers
@using BlazorExecutionFlow.Models
@using BlazorExecutionFlow.Models.NodeV2
@using System.Text.Json
@using static BlazorExecutionFlow.Helpers.DrawflowHelpers
@inject NavigationManager Navigation
@inject ExampleApp.Services.WorkflowService WorkflowService

<div class="page-container">
    <div class="page-header">
        <div>
            <h1 class="page-title">@GetWorkflowTitle()</h1>
            <p class="page-description">@GetWorkflowDescription()</p>
        </div>
        <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-sm btn-primary" @onclick="SaveWorkflow">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 1rem; height: 1rem;">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                    <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                Save
            </button>
            <button class="btn btn-sm btn-outline-secondary" @onclick="BackToWorkflows">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 1rem; height: 1rem;">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Back to Workflows
            </button>
        </div>
    </div>

    <div class="canvas-container">
        <div class="canvas-wrapper">
            @if (_graph is not null)
            {
                <BlazorExecutionFlowGraph Id="@($"BlazorExecutionFlow-{WorkflowId}")"
                                          Style="height:100vh;"
                                          Options="@options"
                                          Graph="_graph"
                                          WorkflowParameters="_workflowInfo.Inputs"/>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public string WorkflowId { get; set; } = string.Empty;

    private Dictionary<string, object> options = new Dictionary<string, object>() { ["reroute"] = true };
    private Graph? _graph;
	private WorkflowInfo? _workflowInfo;
    private bool _isLoaded = false;

    protected override void OnInitialized()
    {
         // Load existing workflow data if available
        var workflow = WorkflowService.GetWorkflow(WorkflowId);
        if (workflow != null)
        {
            try
            {
                _graph = workflow.FlowGraph;
				_workflowInfo = workflow;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Failed to load workflow: {ex.Message}");
            }
        }
		_isLoaded = true;
	}

    private string GetWorkflowTitle()
    {
        var workflow = WorkflowService.GetWorkflow(WorkflowId);
        return workflow?.Name ?? "Workflow Canvas";
    }

    private string GetWorkflowDescription()
    {
        var workflow = WorkflowService.GetWorkflow(WorkflowId);
        return workflow?.Description ?? "Drag nodes from the toolbar to build your visual workflow";
    }


    private async Task SaveWorkflow()
    {
        if (_graph == null) return;

        try
        {
            // Update the workflow in the service
            var workflow = WorkflowService.GetWorkflow(WorkflowId);
            if (workflow != null)
            {
                workflow.FlowGraph = _graph;
                workflow.ModifiedAt = DateTime.Now;
                WorkflowService.UpdateWorkflow(workflow);

                Console.WriteLine("Workflow saved successfully!");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to save workflow: {ex.Message}");
        }
    }

    private void BackToWorkflows()
    {
        Navigation.NavigateTo("/workflows");
    }
}
