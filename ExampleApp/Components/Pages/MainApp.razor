@page "/"
@page "/workflows"
@page "/workflow/{WorkflowId}"
@using BlazorWorkflow.Components
@using BlazorWorkflow.Helpers
@using BlazorWorkflow.Models
@using BlazorWorkflow.Models.NodeV2
@using BlazorWorkflow.Services
@using ExampleApp.Components.Layout
@using ExampleApp.Components
@using System.Collections.Frozen
@layout EmptyLayout
@inject IWorkflowService WorkflowService
@inject IEnvironmentVariablesService EnvVarService

<PageTitle>@GetPageTitle()</PageTitle>

<div style="height: 100vh; overflow: hidden; background: var(--bw-background); color: var(--bw-text-primary); position: relative;">
    <div style="position: fixed; top: 16px; right: 16px; z-index: 1000;">
        <ThemeToggle @rendermode="InteractiveServer" />
    </div>

    @if (currentView == ViewState.WorkflowList)
    {
        <WorkflowManager
            @rendermode="InteractiveServer"
            OnEditWorkflow="HandleEditWorkflow" />
    }
    else if (currentView == ViewState.WorkflowEditor && !string.IsNullOrEmpty(currentWorkflowId))
    {
        <WorkflowEditor
            @rendermode="InteractiveServer"
            WorkflowId="@currentWorkflowId"
            OnBackToWorkflows="HandleBackToWorkflows" />
    }
</div>

@code {
    [Parameter]
    public string? WorkflowId { get; set; }

    private enum ViewState
    {
        WorkflowList,
        WorkflowEditor
    }

    private ViewState currentView = ViewState.WorkflowList;
    private string? currentWorkflowId = null;

    protected override void OnParametersSet()
    {
        // Determine the view based on the route parameter
        if (!string.IsNullOrEmpty(WorkflowId))
        {
            currentView = ViewState.WorkflowEditor;
            currentWorkflowId = WorkflowId;
        }
        else
        {
            currentView = ViewState.WorkflowList;
            currentWorkflowId = null;
        }
    }

    private string GetPageTitle()
    {
        return currentView switch
        {
            ViewState.WorkflowEditor => "Workflow Editor",
            _ => "Workflows"
        };
    }

    private void HandleEditWorkflow(string workflowId)
    {
        currentView = ViewState.WorkflowEditor;
        currentWorkflowId = workflowId;
        StateHasChanged();
    }

    private void HandleBackToWorkflows()
    {
        currentView = ViewState.WorkflowList;
        currentWorkflowId = null;
        StateHasChanged();
    }
}
