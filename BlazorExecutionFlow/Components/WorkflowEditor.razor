@namespace BlazorExecutionFlow.Components
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using BlazorExecutionFlow.Flow.BaseNodes
@using BlazorExecutionFlow.Helpers
@using BlazorExecutionFlow.Models
@using BlazorExecutionFlow.Models.NodeV2
@using BlazorExecutionFlow.Services
@using System.Text.Json
@using static BlazorExecutionFlow.Helpers.DrawflowHelpers
@inject IWorkflowService WorkflowService
@inject IEnvironmentVariablesService EnvVarService

<div class="page-container">
    <div class="page-header">
        <div>
            @if (isEditingWorkflowName)
            {
                <input type="text"
                       class="workflow-name-input-editor"
                       value="@editingWorkflowName"
                       @oninput="@(e => editingWorkflowName = e.Value?.ToString() ?? string.Empty)"
                       @onblur="HandleWorkflowNameBlur"
                       @onkeydown="HandleWorkflowNameKeyDown"
                       @ref="workflowNameInput"
                       placeholder="Workflow name..." />
            }
            else
            {
                <div class="workflow-name-display-editor">
                    <h1 class="page-title">@GetWorkflowTitle()</h1>
                    <button class="btn-icon-edit-small" @onclick="StartEditingWorkflowName" title="Edit workflow name">
                        <i class="bi bi-pencil"></i>
                    </button>
                </div>
            }
            <p class="page-description">@GetWorkflowDescription()</p>
        </div>
        <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-sm btn-outline-secondary" @onclick="BackToWorkflows">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 1rem; height: 1rem;">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Back to Workflows
            </button>
        </div>
    </div>

    <div class="canvas-container">
        <div class="canvas-wrapper">
            @if (_graph is not null)
            {
                <BlazorExecutionFlowGraph Id="@($"BlazorExecutionFlow-{WorkflowId}")"
                                          Style="height:100vh;"
                                          Options="@options"
                                          Graph="_graph"
                                          WorkflowParameters="_workflowInfo.Inputs"
                                          EnvironmentVariables="_environmentVariables"
                                          EnableStatusAnimations="EnableStatusAnimations"
                                          OnEvent="SaveWorkflow"/>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public string WorkflowId { get; set; } = string.Empty;

    [Parameter]
    public EventCallback OnBackToWorkflows { get; set; }
    [Parameter] public bool EnableStatusAnimations { get; set; } = true;

    private Dictionary<string, object> options = new Dictionary<string, object>() { ["reroute"] = true };
    private Graph? _graph;
	private WorkflowInfo? _workflowInfo;
    private bool isEditingWorkflowName = false;
    private string editingWorkflowName = string.Empty;
    private ElementReference workflowNameInput;
    private Dictionary<string, string> _environmentVariables = new();
    private string _selectedEnvironment = "Development";

    protected override void OnInitialized()
    {
         // Load existing workflow data if available
        var workflow = WorkflowService.GetWorkflow(WorkflowId);
        if (workflow != null)
        {
            try
            {
                _graph = workflow.FlowGraph;
				_workflowInfo = workflow;
            }
            catch (Exception ex)
            {
            }
        }

        // Load environment variables for the default environment
        var environments = EnvVarService.GetAllEnvironments();
        if (environments.Any())
        {
            _selectedEnvironment = environments.First();
            _environmentVariables = EnvVarService.GetAllVariables(_selectedEnvironment);
        }
	}

    private string GetWorkflowTitle()
    {
        var workflow = WorkflowService.GetWorkflow(WorkflowId);
        return workflow?.Name ?? "Workflow Canvas";
    }

    private string GetWorkflowDescription()
    {
        var workflow = WorkflowService.GetWorkflow(WorkflowId);
        return workflow?.Description ?? "Drag nodes from the toolbar to build your visual workflow";
    }


    private async Task SaveWorkflow()
    {
        if (_graph == null) return;

        try
        {
            // Update the workflow in the service
            var workflow = WorkflowService.GetWorkflow(WorkflowId);
            if (workflow != null)
            {
                workflow.FlowGraph = _graph;
                workflow.ModifiedAt = DateTime.Now;
                WorkflowService.UpdateWorkflow(workflow);
            }
        }
        catch (Exception ex)
        {
        }
    }

    private async Task BackToWorkflows()
    {
        if (OnBackToWorkflows.HasDelegate)
        {
            await OnBackToWorkflows.InvokeAsync();
        }
    }

    private async Task StartEditingWorkflowName()
    {
        var workflow = WorkflowService.GetWorkflow(WorkflowId);
        if (workflow == null) return;

        isEditingWorkflowName = true;
        editingWorkflowName = workflow.Name;
        StateHasChanged();

        // Focus the input after it's rendered
        await Task.Delay(10);
        await workflowNameInput.FocusAsync();
    }

    private async Task HandleWorkflowNameBlur()
    {
        await SaveWorkflowName();
    }

    private async Task HandleWorkflowNameKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SaveWorkflowName();
        }
        else if (e.Key == "Escape")
        {
            CancelEditingWorkflowName();
        }
    }

    private async Task SaveWorkflowName()
    {
        var workflow = WorkflowService.GetWorkflow(WorkflowId);
        if (workflow == null) return;

        var trimmedName = editingWorkflowName.Trim();

        // Only update if the name has changed and is not empty
        if (!string.IsNullOrWhiteSpace(trimmedName) && trimmedName != workflow.Name)
        {
            workflow.Name = trimmedName;
            workflow.ModifiedAt = DateTime.Now;
            WorkflowService.UpdateWorkflow(workflow);
        }

        isEditingWorkflowName = false;
        StateHasChanged();
    }

    private void CancelEditingWorkflowName()
    {
        isEditingWorkflowName = false;
        editingWorkflowName = string.Empty;
        StateHasChanged();
    }
}
