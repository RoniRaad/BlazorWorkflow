@namespace BlazorExecutionFlow.Components
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using Microsoft.JSInterop
@using BlazorExecutionFlow.Models
@using BlazorExecutionFlow.Helpers

<div class="workflow-manager">
    <div class="workflow-sidebar">
        <div class="sidebar-tabs">
            <button class="tab-button @(activeTab == "workflows" ? "active" : "")" @onclick="@(() => SwitchTab("workflows"))">
                <i class="bi bi-diagram-3"></i> Workflows
            </button>
            <button class="tab-button @(activeTab == "config" ? "active" : "")" @onclick="@(() => SwitchTab("config"))">
                <i class="bi bi-gear"></i> Configuration
            </button>
        </div>

        @if (activeTab == "workflows")
        {
            <div class="sidebar-header">
                <div>
                    <h5>Workflows</h5>
                    <small>@Workflows.Count workflow@(Workflows.Count == 1 ? "" : "s")</small>
                </div>
                <button class="btn-primary-custom" @onclick="HandleCreateWorkflow">
                    <i class="bi bi-plus-lg"></i> New
                </button>
            </div>

            <div class="environment-selector-compact">
                <label>Environment</label>
                <select class="environment-dropdown" @onchange="HandleEnvironmentChange">
                    @foreach (var env in Environments)
                    {
                        <option value="@env" selected="@(env == SelectedEnvironment)">@env</option>
                    }
                </select>
            </div>

        <div class="sidebar-search">
            <input type="text" placeholder="Search workflows..." @bind="searchQuery" @bind:event="oninput" />
            <i class="bi bi-search"></i>
        </div>

        <div class="workflow-list">
            @if (FilteredWorkflows.Any())
            {
                @foreach (var workflow in FilteredWorkflows)
                {
                    <div class="workflow-item @(selectedWorkflowId == workflow.Id ? "selected" : "")"
                         @onclick="@(() => SelectWorkflow(workflow.Id))">
                        <div class="workflow-item-header">
                            <h6>@workflow.Name</h6>
                            <small>@workflow.ModifiedAt.ToString("MMM d")</small>
                        </div>
                        @if (!string.IsNullOrWhiteSpace(workflow.Description))
                        {
                            <p class="workflow-desc">@workflow.Description</p>
                        }
                        @if (workflow.PreviousExecutions.Any())
                        {
                            var lastExecution = workflow.PreviousExecutions.OrderByDescending(e => e.ExecutedAt).First();
                            <div class="workflow-status @(lastExecution.Success ? "success" : "error")">
                                <i class="bi @(lastExecution.Success ? "bi-check-circle" : "bi-x-circle")"></i>
                                @(lastExecution.Success ? "Last run successful" : "Last run failed")
                            </div>
                        }
                    </div>
                }
            }
            else
            {
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <p>No workflows found</p>
                    @if (string.IsNullOrWhiteSpace(searchQuery))
                    {
                        <button class="btn-primary-custom" @onclick="HandleCreateWorkflow">Create your first workflow</button>
                    }
                </div>
            }
        </div>
        }
        else
        {
            <div class="config-sidebar-content">
                <div class="sidebar-header">
                    <div>
                        <h5>Configuration</h5>
                        <small>Environment settings</small>
                    </div>
                </div>
                <div class="environment-selector">
                    <label>Environment</label>
                    <div class="environment-controls">
                        <select class="environment-dropdown" @onchange="HandleEnvironmentChange">
                            @foreach (var env in Environments)
                            {
                                <option value="@env" selected="@(env == SelectedEnvironment)">@env</option>
                            }
                        </select>
                        <button class="btn-icon-secondary" @onclick="HandleAddEnvironment" title="Add Environment">
                            <i class="bi bi-plus-circle"></i>
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>

    <div class="workflow-detail">
        @if (activeTab == "workflows")
        {
            @if (SelectedWorkflow != null)
            {
                <div class="detail-header">
                <div>
                    @if (isEditingWorkflowName)
                    {
                        <input type="text"
                               class="workflow-name-input"
                               value="@editingWorkflowName"
                               @oninput="@(e => editingWorkflowName = e.Value?.ToString() ?? string.Empty)"
                               @onblur="HandleWorkflowNameBlur"
                               @onkeydown="HandleWorkflowNameKeyDown"
                               @ref="workflowNameInput"
                               placeholder="Workflow name..." />
                    }
                    else
                    {
                        <div class="workflow-name-display">
                            <h2>@SelectedWorkflow.Name</h2>
                            <button class="btn-icon-edit" @onclick="StartEditingWorkflowName" title="Edit workflow name">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </div>
                    }
                    @if (!string.IsNullOrWhiteSpace(SelectedWorkflow.Description))
                    {
                        <p>@SelectedWorkflow.Description</p>
                    }
                </div>
                <div class="detail-actions">
                    <button class="btn-success-custom" @onclick="@(() => OnExecuteWorkflow.InvokeAsync(SelectedWorkflow.Id))">
                        <i class="bi bi-play-fill"></i> Execute
                    </button>
                    <button class="btn-primary-custom" @onclick="@(() => OnEditWorkflow.InvokeAsync(SelectedWorkflow.Id))">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button class="btn-danger-custom" @onclick="HandleDeleteWorkflow">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>

            <div class="detail-meta">
                <span><i class="bi bi-calendar"></i> Created @SelectedWorkflow.CreatedAt.ToString("MMM d, yyyy")</span>
                <span><i class="bi bi-clock"></i> Modified @SelectedWorkflow.ModifiedAt.ToString("MMM d, yyyy 'at' h:mm tt")</span>
                <label class="checkbox-label">
                    <input type="checkbox"
                           checked="@SelectedWorkflow.IncludeAsNode"
                           @onchange="@(e => HandleIncludeAsNodeChange(e.Value))" />
                    <span>Include as node in editor</span>
                </label>
            </div>

            <div class="detail-body">
                <!-- Inputs Section -->
                <div class="detail-section">
                    <div class="section-header">
                        <h5>Inputs</h5>
                        <button class="btn-secondary-custom" @onclick="HandleAddInput">
                            <i class="bi bi-plus-lg"></i> Add Input
                        </button>
                    </div>
                    <div class="section-content">
                        @{
                            var discoveredInputs = GetDiscoveredInputs();
                            var requiredInputs = discoveredInputs.ToList();
                            var extraInputs = SelectedWorkflow.Inputs.Keys
                                .Where(k => !requiredInputs.Contains(k, StringComparer.OrdinalIgnoreCase))
                                .ToList();
                            var hasAnyInputs = requiredInputs.Any() || extraInputs.Any();
                        }

                        @if (hasAnyInputs)
                        {
                            @* Show required inputs from GetInput nodes *@
                            @foreach (var inputName in requiredInputs)
                            {
                                var hasValue = SelectedWorkflow.Inputs.TryGetValue(inputName, out var value);
                                var displayValue = hasValue ? value?.ToString() ?? string.Empty : string.Empty;

                                <div class="param-row input-required">
                                    <div class="param-key">
                                        <input type="text"
                                               class="input-name-input"
                                               value="@inputName"
                                               @onchange="@(e => HandleInputNameChange(inputName, e.Value?.ToString() ?? string.Empty, isRequired: true))"
                                               placeholder="Input name..." />
                                        <span class="input-badge required">Required</span>
                                        @if (hasValue)
                                        {
                                            <button class="btn-icon-danger" @onclick="@(() => HandleRemoveInput(inputName))">
                                                <i class="bi bi-x-circle"></i>
                                            </button>
                                        }
                                    </div>
                                    <input type="text"
                                           style="margin-left: 10px;"
                                           value="@displayValue"
                                           @oninput="@(e => HandleInputValueChange(inputName, e.Value?.ToString() ?? string.Empty))"
                                           placeholder="@(hasValue ? "" : "Enter value...")" />
                                </div>
                            }

                            @* Show extra/unused inputs *@
                            @if (extraInputs.Any())
                            {
                                <div class="unused-inputs-divider">
                                    <span>Unused Inputs</span>
                                </div>

                                @foreach (var inputName in extraInputs)
                                {
                                    var value = SelectedWorkflow.Inputs[inputName];

                                    <div class="param-row input-unused">
                                        <div class="param-key">
                                            <input type="text"
                                                   class="input-name-input"
                                                   value="@inputName"
                                                   @onchange="@(e => HandleInputNameChange(inputName, e.Value?.ToString() ?? string.Empty, isRequired: false))"
                                                   placeholder="Input name..." />
                                            <span class="input-badge unused">Unused</span>
                                            <button class="btn-icon-danger" @onclick="@(() => HandleRemoveInput(inputName))">
                                                <i class="bi bi-x-circle"></i>
                                            </button>
                                        </div>
                                        <input type="text"
                                               value="@value"
                                               @oninput="@(e => HandleInputValueChange(inputName, e.Value?.ToString() ?? string.Empty))" />
                                    </div>
                                }
                            }
                        }
                        else
                        {
                            <p class="empty-message">No inputs defined. Add a "Get Input" node to your workflow or manually add inputs.</p>
                        }
                    </div>
                </div>

                <!-- Execution History Section -->
                <div class="detail-section">
                    <div class="section-header">
                        <h5>Execution History</h5>
                        @if (SelectedWorkflow.PreviousExecutions.Any())
                        {
                            <span class="badge">@SelectedWorkflow.PreviousExecutions.Count run@(SelectedWorkflow.PreviousExecutions.Count == 1 ? "" : "s")</span>
                        }
                    </div>
                    <div class="section-content">
                        @if (SelectedWorkflow.PreviousExecutions.Any())
                        {
                            @foreach (var execution in SelectedWorkflow.PreviousExecutions.OrderByDescending(e => e.ExecutedAt).Take(10))
                            {
                                <div class="execution-item @(execution.Success ? "success" : "error")">
                                    <div class="execution-header">
                                        <i class="bi @(execution.Success ? "bi-check-circle-fill" : "bi-x-circle-fill")"></i>
                                        <div>
                                            <strong>@(execution.Success ? "Success" : "Failed")</strong>
                                            <small>@execution.ExecutedAt.ToString("MMM d, yyyy 'at' h:mm tt")</small>
                                        </div>
                                        <span class="badge">@FormatDuration(execution.Duration)</span>
                                    </div>
                                    @if (!execution.Success && !string.IsNullOrWhiteSpace(execution.ErrorMessage))
                                    {
                                        <div class="execution-error">@execution.ErrorMessage</div>
                                    }
                                    @if (execution.Output.Any())
                                    {
                                        <details class="execution-output">
                                            <summary>View output (@execution.Output.Count field@(execution.Output.Count == 1 ? "" : "s"))</summary>
                                            <div class="output-content">
                                                @foreach (var output in execution.Output)
                                                {
                                                    <div><strong>@output.Key:</strong> <code>@output.Value</code></div>
                                                }
                                            </div>
                                        </details>
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <p class="empty-message">No execution history yet. Execute the workflow to see results here.</p>
                        }
                    </div>
                </div>
            </div>
        }
            else
            {
                <div class="empty-detail">
                    <i class="bi bi-file-earmark-text"></i>
                    <h3>No workflow selected</h3>
                    <p>Select a workflow from the sidebar to view details and configuration</p>
                </div>
            }
        }
        else if (activeTab == "config")
        {
            <div class="config-detail">
                <div class="detail-header">
                    <div class="environment-name-container">
                        <input type="text"
                               class="environment-name-input"
                               value="@SelectedEnvironment"
                               @onchange="@(e => HandleEnvironmentNameChange(e.Value?.ToString() ?? string.Empty))"
                               placeholder="Environment name..." />
                        <p>Manage environment variables for this environment</p>
                    </div>
                    @if (Environments.Count > 1)
                    {
                        <div class="detail-actions">
                            <button class="btn-danger-custom" @onclick="HandleDeleteEnvironment">
                                <i class="bi bi-trash"></i> Delete Environment
                            </button>
                        </div>
                    }
                </div>

                <div class="detail-body">
                    <div class="detail-section">
                        <div class="section-header">
                            <h5>Environment Variables</h5>
                            <button class="btn-secondary-custom" @onclick="HandleAddEnvVar">
                                <i class="bi bi-plus-lg"></i> Add Variable
                            </button>
                        </div>
                        <div class="section-content">
                            @if (EnvironmentVariables.Any())
                            {
                                @foreach (var envVar in EnvironmentVariables.OrderBy(kv => kv.Key))
                                {
                                    <div class="param-row env-var-row">
                                        <div class="env-var-key-container">
                                            <input type="text"
                                                   class="env-var-key-input"
                                                   value="@envVar.Key"
                                                   @onchange="@(e => HandleEnvVarKeyChange(envVar.Key, e.Value?.ToString() ?? string.Empty))"
                                                   placeholder="Variable name..." />
                                            <button class="btn-icon-danger" @onclick="@(() => HandleRemoveEnvVar(envVar.Key))">
                                                <i class="bi bi-x-circle"></i>
                                            </button>
                                        </div>
                                        <input type="text"
                                               class="env-var-value-input"
                                               value="@envVar.Value"
                                               @oninput="@(e => HandleEnvVarValueChange(envVar.Key, e.Value?.ToString() ?? string.Empty))"
                                               placeholder="Enter value..." />
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="empty-state">
                                    <i class="bi bi-gear"></i>
                                    <p>No environment variables defined</p>
                                    <button class="btn-primary-custom" @onclick="HandleAddEnvVar">
                                        <i class="bi bi-plus-lg"></i> Add Variable
                                    </button>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public List<WorkflowInfo> Workflows { get; set; } = new();
    [Parameter] public Dictionary<string, string> EnvironmentVariables { get; set; } = new();
    [Parameter] public List<string> Environments { get; set; } = new();
    [Parameter] public string SelectedEnvironment { get; set; } = "Development";
    [Parameter] public EventCallback<CreateWorkflowRequest> OnCreateWorkflow { get; set; }
    [Parameter] public EventCallback<WorkflowInfo> OnUpdateWorkflow { get; set; }
    [Parameter] public EventCallback<string> OnDeleteWorkflow { get; set; }
    [Parameter] public EventCallback<string> OnEditWorkflow { get; set; }
    [Parameter] public EventCallback<string> OnExecuteWorkflow { get; set; }
    [Parameter] public EventCallback<string> OnEnvironmentChanged { get; set; }
    [Parameter] public EventCallback OnAddEnvironment { get; set; }
    [Parameter] public EventCallback OnDeleteEnvironment { get; set; }
    [Parameter] public EventCallback<string> OnEnvironmentRenamed { get; set; }
    [Parameter] public EventCallback<string> OnAddEnvVar { get; set; }
    [Parameter] public EventCallback<string> OnRemoveEnvVar { get; set; }
    [Parameter] public EventCallback<(string OldKey, string NewKey)> OnEnvVarKeyChanged { get; set; }
    [Parameter] public EventCallback<(string Key, string Value)> OnEnvVarChanged { get; set; }

    private string searchQuery = string.Empty;
    private string? selectedWorkflowId = null;
    private string activeTab = "workflows";
    private bool isEditingWorkflowName = false;
    private string editingWorkflowName = string.Empty;
    private ElementReference workflowNameInput;

    private WorkflowInfo? SelectedWorkflow => Workflows.FirstOrDefault(w => w.Id == selectedWorkflowId);

    private IEnumerable<WorkflowInfo> FilteredWorkflows
    {
        get
        {
            if (string.IsNullOrWhiteSpace(searchQuery))
                return Workflows.OrderByDescending(w => w.ModifiedAt);

            var query = searchQuery.ToLower();
            return Workflows
                .Where(w => w.Name.ToLower().Contains(query) ||
                           (w.Description?.ToLower().Contains(query) ?? false))
                .OrderByDescending(w => w.ModifiedAt);
        }
    }

    protected override void OnParametersSet()
    {
        if (selectedWorkflowId == null && Workflows.Any())
        {
            selectedWorkflowId = Workflows.OrderByDescending(w => w.ModifiedAt).First().Id;
        }
    }

    private void SelectWorkflow(string workflowId)
    {
        selectedWorkflowId = workflowId;
    }

    private async Task HandleCreateWorkflow()
    {
        await OnCreateWorkflow.InvokeAsync(new CreateWorkflowRequest());
    }

    private async Task HandleDeleteWorkflow()
    {
        if (selectedWorkflowId != null)
        {
            await OnDeleteWorkflow.InvokeAsync(selectedWorkflowId);
            selectedWorkflowId = null;
        }
    }

    private async Task HandleAddInput()
    {
        if (SelectedWorkflow == null) return;
        var key = $"input_{SelectedWorkflow.Inputs.Count + 1}";
        SelectedWorkflow.Inputs[key] = string.Empty;
        await OnUpdateWorkflow.InvokeAsync(SelectedWorkflow);
    }

    private async Task HandleRemoveInput(string key)
    {
        if (SelectedWorkflow == null) return;
        SelectedWorkflow.Inputs.Remove(key);
        await OnUpdateWorkflow.InvokeAsync(SelectedWorkflow);
    }

    private async Task HandleInputValueChange(string key, string value)
    {
        if (SelectedWorkflow == null) return;
        SelectedWorkflow.Inputs[key] = value;
        await OnUpdateWorkflow.InvokeAsync(SelectedWorkflow);
    }

    private async Task HandleInputNameChange(string oldName, string newName, bool isRequired)
    {
        if (SelectedWorkflow == null || string.IsNullOrWhiteSpace(newName) || oldName == newName)
            return;

        // If this is a required input, update the GetInput node
        if (isRequired && SelectedWorkflow.FlowGraph != null)
        {
            foreach (var node in SelectedWorkflow.FlowGraph.Nodes.Values)
            {
                var inputNameMappings = node.NodeInputToMethodInputMap
                    .Where(m => m.From.Contains($"workflow.parameters.{oldName}"));

                inputNameMappings
                .ToList()
                .ForEach(mapping =>
                {
                    mapping.From = mapping.From.Replace($"workflow.parameters.{oldName}", $"workflow.parameters.{newName}");
                });
            }
        }

        // Rename the key in the Inputs dictionary if it exists
        if (SelectedWorkflow.Inputs.TryGetValue(oldName, out var value))
        {
            SelectedWorkflow.Inputs.Remove(oldName);
            SelectedWorkflow.Inputs[newName] = value;
        }

        await OnUpdateWorkflow.InvokeAsync(SelectedWorkflow);
    }

    private string FormatDuration(TimeSpan duration)
    {
        if (duration.TotalSeconds < 1)
            return $"{duration.TotalMilliseconds:F0}ms";
        if (duration.TotalMinutes < 1)
            return $"{duration.TotalSeconds:F1}s";
        if (duration.TotalHours < 1)
            return $"{duration.TotalMinutes:F1}m";
        return $"{duration.TotalHours:F1}h";
    }

    private void SwitchTab(string tab)
    {
        activeTab = tab;
        StateHasChanged();
    }

    private async Task HandleAddEnvVar()
    {
        var key = $"VAR_{EnvironmentVariables.Count + 1}";
        await OnAddEnvVar.InvokeAsync(key);
    }

    private async Task HandleRemoveEnvVar(string key)
    {
        await OnRemoveEnvVar.InvokeAsync(key);
    }

    private async Task HandleEnvVarValueChange(string key, string value)
    {
        await OnEnvVarChanged.InvokeAsync((key, value));
    }

    private async Task HandleEnvVarKeyChange(string oldKey, string newKey)
    {
        if (string.IsNullOrWhiteSpace(newKey) || oldKey == newKey)
            return;

        await OnEnvVarKeyChanged.InvokeAsync((oldKey, newKey));
    }

    private async Task HandleEnvironmentChange(ChangeEventArgs e)
    {
        var newEnvironment = e.Value?.ToString();
        if (!string.IsNullOrEmpty(newEnvironment))
        {
            await OnEnvironmentChanged.InvokeAsync(newEnvironment);
        }
    }

    private async Task HandleAddEnvironment()
    {
        await OnAddEnvironment.InvokeAsync();
    }

    private async Task HandleDeleteEnvironment()
    {
        await OnDeleteEnvironment.InvokeAsync();
    }

    private async Task HandleEnvironmentNameChange(string newName)
    {
        if (string.IsNullOrWhiteSpace(newName) || newName == SelectedEnvironment)
            return;

        await OnEnvironmentRenamed.InvokeAsync(newName);
    }

    private List<string> GetDiscoveredInputs()
    {
        if (SelectedWorkflow == null || SelectedWorkflow.FlowGraph.Nodes.Count < 1)
            return new List<string>();

        try
        {
            return WorkflowInputDiscovery.DiscoverInputs(SelectedWorkflow.FlowGraph);
        }
        catch
        {
            return new List<string>();
        }
    }

    private async Task StartEditingWorkflowName()
    {
        if (SelectedWorkflow == null) return;

        isEditingWorkflowName = true;
        editingWorkflowName = SelectedWorkflow.Name;
        StateHasChanged();

        // Focus the input after it's rendered
        await Task.Delay(10);
        await workflowNameInput.FocusAsync();
    }

    private async Task HandleWorkflowNameBlur()
    {
        await SaveWorkflowName();
    }

    private async Task HandleWorkflowNameKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SaveWorkflowName();
        }
        else if (e.Key == "Escape")
        {
            CancelEditingWorkflowName();
        }
    }

    private async Task SaveWorkflowName()
    {
        if (SelectedWorkflow == null) return;

        var trimmedName = editingWorkflowName.Trim();

        // Only update if the name has changed and is not empty
        if (!string.IsNullOrWhiteSpace(trimmedName) && trimmedName != SelectedWorkflow.Name)
        {
            SelectedWorkflow.Name = trimmedName;
            await OnUpdateWorkflow.InvokeAsync(SelectedWorkflow);
        }

        isEditingWorkflowName = false;
        StateHasChanged();
    }

    private void CancelEditingWorkflowName()
    {
        isEditingWorkflowName = false;
        editingWorkflowName = string.Empty;
        StateHasChanged();
    }

    private async Task HandleIncludeAsNodeChange(object? value)
    {
        if (SelectedWorkflow == null || value == null) return;

        SelectedWorkflow.IncludeAsNode = (bool)value;
        await OnUpdateWorkflow.InvokeAsync(SelectedWorkflow);
    }
}
