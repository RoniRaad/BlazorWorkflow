@page "/"
@using DrawflowWrapper.Components
@using DrawflowWrapper.Drawflow.BaseNodes
@using DrawflowWrapper.Helpers
@using DrawflowWrapper.Models

<h1>Drawflow Blazor Wrapper Demo</h1>

<!-- Button trigger modal -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
    Launch demo modal
</button>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                ...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>


<div style="display:flex;;flex-direction: row;">
    <div style="display:flex;margin-bottom:5px;flex-direction: column;margin-right: 8px;width: 350px;">
        <div style="display:flex;justify-content: space-between;margin-bottom:8px">
            <button class="btn btn-sm btn-primary" @onclick="AddEvent">+ Event</button>
            <button class="btn btn-sm btn-primary" @onclick="Export">Export</button>
            <button class="btn btn-sm btn-primary" @onclick="Clear">Clear</button>
            <button class="btn btn-sm btn-primary" @onclick="@(() => _base?.CreateInternalGraph().ConfigureAwait(false))">Run</button>
        </div>
        <div style="display: flex;gap: 5px;overflow:auto;flex-direction: column;height:80vh" class="controls">
            @foreach (var nodeGroup in _functionNodes.GroupBy(x => x.Section))
            {
                <div class="accordion" id="accordion-@nodeGroup.FirstOrDefault()?.Section.GetHashCode()">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-@nodeGroup.FirstOrDefault()?.Section.GetHashCode()">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-@nodeGroup.FirstOrDefault()?.Section.GetHashCode()" aria-expanded="true" aria-controls="collapse-@nodeGroup.FirstOrDefault()?.Section.GetHashCode()">
                                @nodeGroup.FirstOrDefault()?.Section
                            </button>
                        </h2>
                        <div id="collapse-@nodeGroup.FirstOrDefault()?.Section.GetHashCode()" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#accordion-@nodeGroup.FirstOrDefault()?.Section.GetHashCode()">
                            <div class="accordion-body" style="display: flex;flex-wrap: wrap;gap: 5px;">
                                @foreach (var node in nodeGroup)
                                {
                                    <button class="btn btn-sm btn-primary" @onclick="(() => CreateNode(node))">@node.Name</button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }


        </div>
    </div>
    <Drawflow @ref="_base"
              Id="df-demo"
              Style="height:600px;"
              Options="@options"
              OnEvent="HandleEvent" />
</div>



@if (!string.IsNullOrWhiteSpace(_exportJson))
{
    <pre style="white-space:pre-wrap;border:1px solid #ddd;padding:8px;border-radius:8px;max-height:240px;overflow:auto;">@_exportJson</pre>
}

@code {
    private Dictionary<string, object> options = new Dictionary<string, object>() { ["reroute"] = true };
    private DrawflowBase? _base;
    private string? _exportJson;
    private List<FunctionNode> _functionNodes = [];

    private async Task HandleEvent(DrawflowEventArgs e)
    {
        await InvokeAsync(StateHasChanged);
    }

    protected override void OnInitialized()
    {
        _functionNodes = DrawflowHelpers.GetNodesObjects();
        base.OnInitialized();
    }

    private async Task CreateNode(FunctionNode node)
    {
        if (_base is null) return;
        if (node.Type == NodeType.BooleanOperation)
        {
            await _base.CreateBooleanNode(node);
        }
        else if (node.Type == NodeType.Function)
        {
            await _base.CreateFunctionNode(node);
        }
        else if (node.Type == NodeType.Loop)
        {
            await _base.CreateLoopNode(node);
        }
    }

    private async Task AddNode()
    {
        if (_base is null) return;
        await _base.CreateFunctionNode(BaseNodeCollection.Log);
    }

    private async Task AddTestNode()
    {
        if (_base is null) return;
        await _base.CreateFunctionNode(BaseNodeCollection.Add);
    }

    private async Task AddRandomNode()
    {
        if (_base is null) return;
        await _base.CreateFunctionNode(BaseNodeCollection.RandomInteger);
    }

    private async Task AddEvent()
    {
        if (_base is null) return;
        await _base.CreateEventNode("Start");
    }

    private async Task Export()
    {
        if (_base is null) return;
        var exported = await _base.CallAsync<object>("export");
        _exportJson = System.Text.Json.JsonSerializer.Serialize(exported, new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
    }

    private async Task Clear()
    {
        if (_base is null) return;
        await _base.CallAsync<object>("clear");
        _exportJson = null;
    }
}
